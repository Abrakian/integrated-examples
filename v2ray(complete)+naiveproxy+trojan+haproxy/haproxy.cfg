global
	log /dev/log	local0
	log /dev/log	local1 notice
	chroot /var/lib/haproxy
	stats socket /run/haproxy/admin.sock mode 660 level admin
	stats timeout 30s
	user haproxy
	group haproxy
	daemon

defaults
	log	global
	mode	tcp
	option	tcplog
	option	dontlognull
        timeout connect 5000
        timeout client  50000
        timeout server  50000
        errorfile 400 /etc/haproxy/errors/400.http
        errorfile 403 /etc/haproxy/errors/403.http
        errorfile 408 /etc/haproxy/errors/408.http
        errorfile 500 /etc/haproxy/errors/500.http
        errorfile 502 /etc/haproxy/errors/502.http
        errorfile 503 /etc/haproxy/errors/503.http
        errorfile 504 /etc/haproxy/errors/504.http

frontend sni_proxy
        mode tcp
        bind *:443
        tcp-request inspect-delay 5s
        tcp-request content accept if { req.ssl_hello_type 1 }

        acl acl_v2ray req_ssl_sni -i zv.xx.yy
        acl acl_trojan req_ssl_sni -i zt.xx.yy
        acl acl_caddy req_ssl_sni -i zc.xx.yy

        use_backend v2ray if acl_v2ray
        use_backend trojan if acl_trojan
        use_backend caddy if acl_caddy

backend v2ray
        mode tcp
        server v2ray 127.0.0.1:8443

backend trojan
        mode tcp
        server trojan 127.0.0.1:2083

backend caddy
        mode tcp
        server caddy 127.0.0.1:7443
